<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">



<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}

kbd {
  display: inline-block;
  padding: 3px 5px;
  font-size: 11px;
  line-height: 10px;
  color: #555;
  vertical-align: middle;
  background-color: #fcfcfc;
  border: solid 1px #ccc;
  border-bottom-color: #bbb;
  border-radius: 3px;
  box-shadow: inset 0 -1px 0 #bbb
}

* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>


</head>

<body>

<h1 id="toc_0">Projet NSY102 - Composite WEB OF THING- jmDNS</h1>

<h4 id="toc_1"><em>28/04/2021</em></h4>

<table>
<thead>
<tr>
<th style="text-align: left">Nom</th>
<th style="text-align: center">Prénom</th>
<th style="text-align: right">Matricule</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left">VALENTIN</td>
<td style="text-align: center">Fabien</td>
<td style="text-align: right">0g5drtfg8y8</td>
</tr>
</tbody>
</table>

<h2 id="toc_2">Introduction</h2>

<h3 id="toc_3">En m&#39;inspirant de votre idée proposée sur le forum j&#39;ai développé une mini application permettant d&#39;imaginer une maison domotisée avec des pièces contenant des services d&#39;objets connectés WebOfThing et de les détecter via jmDNS.</h3>

<h3 id="toc_4">Exécuter le jeu d&#39;essai du projet :</h3>

<ul>
<li><p>Lancer la classe jmDNS/MainDiscoverServices</p></li>
<li><p>Lancer la classe MainWoT</p></li>
</ul>

<p><em>Info DNS &quot;webthing&quot; dans le terminal :</em></p>

<div><pre><code class="language-none">dns-sd -B _webthing</code></pre></div>

<h2 id="toc_5">Questions</h2>

<h3 id="toc_6">Q1) Création grâce au patron composite d&#39;une maison avec des pièces (cuisine, salle de bain..) avec des objets connectés WebOfThing dans chaques pièces. (1 objet = 1 serveur API WebOfThing)</h3>

<p>L&#39;ensemble des classes constituantes du patron composite des objets WoT se trouvent dans le package CompositeWot</p>

<h4 id="toc_7">Patron Composite :</h4>

<p><strong>Classe composite :</strong></p>

<div><pre><code class="language-none">public abstract class Composite extends Composant implements Iterable&lt;Composant&gt; {
    private List&lt;Composant&gt; list;

    public Composite(String title) {
        super(title);
        this.list = new ArrayList&lt;&gt;();
    }

    public Composite ajouter(Composant composant) {
        composant.setPieceMere(this.getNom());
        list.add(composant);
        return this;
    }

    public int nombreDeIoT() {
        int nombre = 0;
        for (Composant c : this) {
            nombre += c.nombreDeIoT();
        }
        return nombre;
    }

    @Override
    public Iterator&lt;Composant&gt; iterator() {
        return list.iterator();
    }
}</code></pre></div>

<p><strong>Classe Liste de composants :</strong></p>

<div><pre><code class="language-none">public class ListeDeComposants extends Composite {

    public ListeDeComposants(String nom) {
        super(nom);
    }

    @Override
    public WebThingServer getServer() {
        throw new UnsupportedOperationException();
    }

    @Override
    public &lt;T&gt; T accepter(Visiteur&lt;T&gt; visiteur) {
        return visiteur.visite(this);
    }
}</code></pre></div>

<p><strong>Classe Composant :</strong></p>

<div><pre><code class="language-none">public abstract class Composant {

    private String title;
    private String piece;

    public Composant(String title) {
        this.title = title;
    }

    public String getNom() {
        return this.title;
    }

    public abstract WebThingServer getServer();

    public abstract int nombreDeIoT();

    public abstract &lt;T&gt; T accepter(Visiteur&lt;T&gt; visiteur);

    protected void setPieceMere(String nom) {
        this.piece = nom;
    }

    public String getPiece() {
        return piece;
    }
}</code></pre></div>

<p><strong>Une feuille composant WoT :</strong></p>

<p>A chaque composant est associé sa pièce maitresse (<em>ex : ampoule est dans le salon, interrupteur est dans le salle de bain...</em>)</p>

<div><pre><code class="language-none">public class Ampoule extends Composant {

    private WebThingServer server;
    private Thing thing;
    private String id;

    public Ampoule(String title, int port) throws IOException {
        super(title);
        id = UUID.randomUUID().toString();
        thing = new Thing(id,
                title,
                new JSONArray(Arrays.asList(
                        title)),
                &quot;Une ampoule connectée&quot;);

        server = new WebThingServer(new WebThingServer.SingleThing(thing), port);
    }

    protected void setPieceMere(String nom) {
        super.setPieceMere(nom);
        JSONObject onDescription = new JSONObject();
        onDescription.put(&quot;@type&quot;, &quot;Piece&quot;);
        onDescription.put(&quot;nom&quot;, nom);
        onDescription.put(&quot;description&quot;, &quot;La pièce dans laquelle l&#39;objet se trouve&quot;);
        thing.addProperty(new Property(thing,
                &quot;piece&quot;,
                new Value(nom),
                onDescription));
    }

    @Override
    public WebThingServer getServer() {
        return server;
    }

    @Override
    public int nombreDeIoT() {
        return 1;
    }

    @Override
    public &lt;T&gt; T accepter(Visiteur&lt;T&gt; visiteur) {
        return visiteur.visite(this);
    }
}</code></pre></div>

<h3 id="toc_8">Q2) Création d&#39;un visiteur permettant de créer et démarrer/éteindre les services d&#39;objets connectés</h3>

<p>La patron composite va nous permettre de &quot;visiter&quot; chaque composant mais aussi plusieurs composants.
C&#39;est pourquoi, grâce aux deux visiteurs VisiteurOn et VisiteurOff, nous allons pouvoir démarrer ou éteindre le serveur
d&#39;un seul composant WoT mais aussi d&#39;un sous ensemble de composant WoT appartenant à une pièce (<em>salon, cuisine, salle de bain...)</em></p>

<p><strong>Visiteur de démarrage  :</strong></p>

<div><pre><code class="language-none">public class VisiteurOn extends Visiteur&lt;Boolean&gt; {

    @Override
    public Boolean visite(Composant n) {
        try {
            System.out.println(&quot;Starting WoT (pièce &quot; + n.getPiece() + &quot;) :&quot; + n.getNom());
            Runtime.getRuntime().addShutdownHook(new Thread() {
                public void run() {
                    n.getServer().stop();
                }
            });
            Thread.sleep(5000);
            n.getServer().start(false);
        } catch (Exception e) {
            e.printStackTrace();
            return false;
        }
        return true;
    }

    @Override
    public Boolean visite(ListeDeComposants n) {
        boolean result = true;
        for (Composant c : n) {
            result &amp;= c.accepter(this);
        }
        return result;
    }
}</code></pre></div>

<p><strong>Visiteur pour éteindre :</strong></p>

<div><pre><code class="language-none">public class VisiteurOff extends Visiteur&lt;Boolean&gt; {

    @Override
    public Boolean visite(Composant n) {
        try {
            System.out.println(&quot;Stopping WoT :&quot; + n.getNom());
            n.getServer().stop();
        } catch (Exception e) {
            return false;
        }
        return true;
    }

    @Override
    public Boolean visite(ListeDeComposants n) {
        boolean result = true;
        for (Composant c : n) {
            result &amp;= c.accepter(this);
        }
        return result;
    }
}</code></pre></div>

<h3 id="toc_9">Q3) Le jeu d&#39;essai MainWot</h3>

<p>Ci-dessous un petit jeu d&#39;essai pour simuler une maison avec des pièces constituées de composants WoT :</p>

<table>
<thead>
<tr>
<th style="text-align: left">Pièce</th>
<th style="text-align: center">Objets</th>
<th style="text-align: center">Port</th>
</tr>
</thead>

<tbody>
<tr>
<td style="text-align: left">Maison</td>
<td style="text-align: center">Salon</td>
<td style="text-align: center">_</td>
</tr>
<tr>
<td style="text-align: left"></td>
<td style="text-align: center">Cuisine</td>
<td style="text-align: center">_</td>
</tr>
<tr>
<td style="text-align: left"></td>
<td style="text-align: center">Salle de bain</td>
<td style="text-align: center">_</td>
</tr>
<tr>
<td style="text-align: left">Salon</td>
<td style="text-align: center">Ampoule</td>
<td style="text-align: center">8060</td>
</tr>
<tr>
<td style="text-align: left"></td>
<td style="text-align: center">Capteur Temperature</td>
<td style="text-align: center">8070</td>
</tr>
<tr>
<td style="text-align: left"></td>
<td style="text-align: center">Interrupteur</td>
<td style="text-align: center">8080</td>
</tr>
<tr>
<td style="text-align: left">Cuisine</td>
<td style="text-align: center">Ampoule</td>
<td style="text-align: center">8061</td>
</tr>
<tr>
<td style="text-align: left"></td>
<td style="text-align: center">Interrupteur</td>
<td style="text-align: center">8081</td>
</tr>
<tr>
<td style="text-align: left">Salle de bain</td>
<td style="text-align: center">Capteur Temperature</td>
<td style="text-align: center">8071</td>
</tr>
</tbody>
</table>

<div><pre><code class="language-none">public class MainWoT {
    public static void main(String[] args) {

        //Les pièces de la maison :
        ListeDeComposants maison = new ListeDeComposants(&quot;Maison&quot;);
        ListeDeComposants salon = new ListeDeComposants(&quot;Salon&quot;);
        ListeDeComposants cuisine = new ListeDeComposants(&quot;Cuisine&quot;);
        ListeDeComposants sdb = new ListeDeComposants(&quot;Salle de bain&quot;);

        try {
            //3 objets dans le salon...
            Composant iotSalon1 = new Ampoule(&quot;Ampoule&quot;, 8060);
            Composant iotSalon2 = new CapteurTemperature(&quot;Capteur Temperature&quot;, 8070);
            Composant iotSalon3 = new Interrupteur(&quot;Interrupteur&quot;, 8080);

            salon.ajouter(iotSalon1).ajouter(iotSalon2).ajouter(iotSalon3);
            maison.ajouter(salon);

            //visiteurs string+start
            Visiteur&lt;String&gt; visiteurStr = new VisiteurString();
            System.out.println(visiteurStr.visite(maison));
            Visiteur&lt;Boolean&gt; visiteurOn = new VisiteurOn();
            boolean startStatus = visiteurOn.visite(maison); //on démarre tous les objets de la maison...
            System.out.println(&quot;Starting WoT component of house : &quot; + startStatus);

            Thread.sleep(15000);

            Visiteur&lt;Boolean&gt; visiteurOff = new VisiteurOff();
            boolean stopStatus = visiteurOff.visite(maison); //on éteint tous les objets de la maison...
            System.out.println(&quot;Stopping all WoT component of house : &quot; + stopStatus);

            Thread.sleep(15000);
            //2 objets dans la cuisine...
            Composant iotCuisine1 = new Ampoule(&quot;Ampoule&quot;, 8061);
            Composant iotCuisine2 = new CapteurTemperature(&quot;Interrupteur&quot;, 8081);

            cuisine.ajouter(iotCuisine1).ajouter(iotCuisine2);
            maison.ajouter(cuisine);
            //visiteurs string+start
            System.out.println(visiteurStr.visite(maison));
            startStatus = visiteurOn.visite(maison); //on démarre tous les objets de la maison...(salon+cuisine donc..)
            System.out.println(&quot;Starting WoT component of house : &quot; + startStatus);

            Thread.sleep(15000);
            //1 objet dans la salle de bain...
            Composant iotSdb2 = new CapteurTemperature(&quot;Capteur Temperature&quot;, 8071);
            sdb.ajouter(iotSdb2);
            //visiteurs string+start
            System.out.println(visiteurStr.visite(sdb));
            startStatus = visiteurOn.visite(sdb); //on démarre tous les objets de la salle de bain uniquement...
            System.out.println(&quot;Starting WoT component of bathroom only : &quot; + startStatus);

        } catch (IOException e) {
            System.out.println(&quot;Erreur lors du deploiement d&#39;un WoT&quot;);
        } catch (InterruptedException e) {
            System.out.println(&quot;Thead.sleep InterruptedException&quot;);
        }
    }
}</code></pre></div>

<h3 id="toc_10">Q4) Découverte des services DNS WebOfThing via jmDNS. (éteints et démarrés par les visiteurs respectifs).</h3>

<p>La classe suivante permet de découvrir les services mDNS grâce à la librairie jmDNS.</p>

<p>Plus spécifiquement ici, ce sont les services <strong>_webthing</strong> qui nous interesses.</p>

<p>Nous allons installer deux listenners dans l&#39;attente de la découverte de services <strong>_webthing</strong> :</p>

<ul>
<li><p>StringListener  : Se contente d&#39;afficher un retour console.</p></li>
<li><p>IHMListener : Voir Q5</p></li>
</ul>

<p><strong>La classe MainDiscoverServices:</strong></p>

<div><pre><code class="language-none">public class MainDiscoverServices {

    private static final String serviceDNS = &quot;_webthing._tcp.local.&quot;;

    /**
     * @param args the command line arguments
     */
    public static void main(String[] args) {

        Logger logger = Logger.getLogger(JmDNS.class.getName());
        ConsoleHandler handler = new ConsoleHandler();
        logger.addHandler(handler);
        logger.setLevel(Level.FINER);
        handler.setLevel(Level.FINER);
        try {
            JmDNS jmdns = null;

            InetAddress addr = InetAddress.getLocalHost();
            String hostname = InetAddress.getByName(addr.getHostName()).toString();
            try {
                System.out.println(&quot;Listening on &quot; + hostname);
                jmdns = JmDNS.create(addr, hostname); // throws IOException
            } catch (IOException e) {
                e.printStackTrace(); // handle this if you want
            }
            StringListener strListener = new StringListener();
            IHMListener ihmListener = new IHMListener(jmdns);
            //jmdns.addServiceListener(serviceDNS, strListener);
            jmdns.addServiceListener(serviceDNS, ihmListener);

            JmDNS finalJmdns = jmdns;
            Runtime.getRuntime().addShutdownHook(new Thread() {
                public void run() {
                    try {
                        finalJmdns.unregisterAllServices();
                        finalJmdns.removeServiceListener(serviceDNS, strListener);
                        finalJmdns.removeServiceListener(serviceDNS, ihmListener);
                        finalJmdns.close();
                    } catch (Exception e) {
                    }
                }
            });
            System.out.println(&quot;Apputer sur la touche q et Entrer, pour terminer le programme&quot; + jmdns.getInetAddress());

            int b;
            while ((b = System.in.read()) != -1 &amp;&amp; (char) b != &#39;q&#39;) {
                /* en attente utilisateur */
            }
            jmdns.unregisterAllServices();
            jmdns.removeServiceListener(serviceDNS, strListener);
            jmdns.removeServiceListener(serviceDNS, ihmListener);
            jmdns.close();

            System.out.println(&quot;Terminé&quot;);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}</code></pre></div>

<h3 id="toc_11">Q5) IHM pour visualiser le démarrage/arrêt des objets WoT via jmDNS</h3>

<p>Ce listener permet d&#39;ecouter les evenements jmDNS à travers une IHM.</p>

<p>Dans cette IHM j&#39;ai ajouté un bouton permettant de faire une requête sur un service WoT.
Le but de cette requête est de faire une demande concernant la pièce dans laquelle se trouve l&#39;objet connecté.
Cette information est disponible dans le JSON du service jmDNS.</p>

<p>Le bouton va donc déclencher l&#39;appel au Thread <strong>ThreadURLRequest</strong>.
Ce thread est chargé d&#39;executer la requete HTTP ainsi que de parser le JSON de retour de cette requête.</p>

<div><pre><code class="language-none">public class IHMListener implements ServiceListener {

    //JMdns
    private JmDNS jmdns;

    //UI
    private JFrame frame;
    private final DefaultTableModel dm;

    //Json data from WoT object...
    private Vector&lt;Vector&lt;Object&gt;&gt; data;

    public IHMListener(JmDNS jmdns) {
        this.data = new Vector&lt;&gt;();
        this.jmdns = jmdns;
        frame = new JFrame(&quot;Ma maison connectée&quot;);
        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        frame.setSize(800, 300);

        Vector&lt;Object&gt; columnNames = new Vector&lt;&gt;();
        columnNames.add(&quot;Objet WoT&quot;);
        columnNames.add(&quot;API URL&quot;);
        columnNames.add(&quot;Pièce&quot;);

        dm = new DefaultTableModel(data, columnNames);
        JTable table = new JTable(dm);

        JScrollPane scrollPane = new JScrollPane(table);
        scrollPane.setBounds(36, 37, 407, 79);

        Action request = new AbstractAction() {
            public void actionPerformed(ActionEvent e) {

                JTable table = (JTable) e.getSource();
                DefaultTableModel dtm = (DefaultTableModel) table.getModel();
                Vector&lt;String&gt; data = dtm.getDataVector().get(table.getSelectedRow());
                Thread threadURLRequest = new Thread(new ThreadURLRequest(data.get(1), data.get(0)));
                threadURLRequest.start();
            }
        };

        ButtonColumn buttonColumn = new ButtonColumn(table, request, 2);
        buttonColumn.setMnemonic(KeyEvent.VK_D);
        frame.add(table);
        frame.setVisible(true);
    }

    @Override
    public void serviceAdded(ServiceEvent event) {

        ServiceInfo info = jmdns.getServiceInfo(event.getType(), event.getName());
        if (info != null) {
            Vector&lt;Object&gt; aData = new Vector&lt;Object&gt;();
            String url =
                    String.format(&quot;http://%s:%s&quot;,
                            info.getHostAddresses()[0],
                            info.getPort()
                    );

            aData.add(event.getName());
            aData.add(url);
            aData.add(&quot;Pièce ? (Requête HTTP)&quot;);
            data.add(aData);
            dm.fireTableDataChanged();
        }
    }

    @Override
    public void serviceRemoved(ServiceEvent event) {
        try {
            Vector&lt;Vector&gt; foundRow = new Vector&lt;&gt;();
            for (Vector&lt;Object&gt; row : data) {
                if (row.get(0).equals(event.getName())) {
                    foundRow.add(row);
                }
            }
            data.removeAll(foundRow);
            dm.fireTableDataChanged();

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @Override
    public void serviceResolved(ServiceEvent event) { }

    /**
     * Ce thread permet de faire une requete  HTTP pour obtenir le nom de la pièce
     */
    public class ThreadURLRequest implements Runnable {

        private String url;
        private String name;

        public ThreadURLRequest(String url, String name) {
            this.url = url;
            this.name = name;
        }

        @Override
        public void run() {

            JSONObject json = getJSONFromUrl(url + &quot;/properties/piece&quot;);
            String piece = new String(&quot;Requete échouée&quot;);
            if (json != null) {
                piece = json.getString(&quot;piece&quot;);
                System.out.println(&quot;[IHMListener]Requete http de la pièce...(url:&quot; + url + &quot;, nom :&quot; + name + &quot;)&quot; + piece);
            }
            Vector&lt;Vector&gt; foundRow = new Vector&lt;&gt;();
            for (Vector&lt;Object&gt; row : data) {
                if (row.get(0).equals(name)) {
                    foundRow.add(row);
                }
            }
            data.removeAll(foundRow);
            Vector&lt;Object&gt; aData = new Vector&lt;Object&gt;();
            aData.add(name);
            aData.add(url);
            aData.add(piece);
            data.add(aData);
            dm.fireTableDataChanged();

        }

        /**
         * URL to Json Object
         *
         * @param urlStr
         * @return
         */
        public JSONObject getJSONFromUrl(String urlStr) {
            try {
                URL url = new URL(urlStr);
                HttpURLConnection con = (HttpURLConnection) url.openConnection();
                con.setRequestMethod(&quot;GET&quot;);
                con.setRequestProperty(&quot;Content-Type&quot;, &quot;application/json; utf-8&quot;);
                con.setRequestProperty(&quot;Accept&quot;, &quot;application/json&quot;);
                BufferedReader br = new BufferedReader(
                        new InputStreamReader(con.getInputStream(), &quot;utf-8&quot;));

                StringBuilder response = new StringBuilder();
                String responseLine = null;
                while ((responseLine = br.readLine()) != null) {
                    response.append(responseLine.trim());/**/
                }
                JSONObject jsonObject = new JSONObject(
                        &quot;&quot; + response.toString() + &quot;&quot;
                );
                return jsonObject;
            } catch (Exception e) {
                System.out.println(e.toString());
            }
            return null;
        }
    }
}</code></pre></div>




</body>

</html>
